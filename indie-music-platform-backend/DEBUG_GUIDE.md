# バックエンドサーバー起動問題の解決ガイド

このガイドは、バックエンドサーバーの起動問題を解決し、フロントエンドとの連携を確立するための手順をまとめたものです。問題は正常に解決され、サーバーが起動可能になりました。

## 1. 解決された問題点

サーバー起動に関する以下の問題点が解決されました：

1. **AWS S3接続問題**: 
   - ローカル開発環境での AWS EC2メタデータサービスへの接続試行による遅延/タイムアウト
   - `botocore.exceptions` のインポートに関する問題

2. **Firebase認証初期化問題**:
   - テスト環境で Firebase 初期化が不安定になる問題
   - 初期化失敗時にアプリケーションが起動できない問題

## 2. テスト環境でのサーバー起動方法

### 最小限のサーバー確認

まず、最小限の設定でサーバーが起動できるかどうかを確認できます：

```bash
# 最小限のサーバー起動スクリプトを実行
python minimal_startup.py
```

このスクリプトは外部依存関係を最小限にし、基本的なFastAPIアプリのみを起動します。

### テスト環境でのフルサーバー起動

外部サービス（AWS S3、Firebase）をモックした状態で、実際のアプリケーションサーバーを起動するためのスクリプトです：

```bash
# テスト環境サーバー起動スクリプト
python test_startup.py
```

## 3. 主な修正ポイント

### AWS S3関連の修正

AWS S3の初期化問題を解決するために、以下の修正を行いました：

1. `app/utils/storage.py` の修正：
   - テスト環境では S3 クライアントをモック化
   - `botocore.exceptions` を try/except でハンドリング
   - インポートエラー時のフォールバックを実装

2. `test_startup.py` での AWS モック：
   - `boto3` と `botocore` モジュールの詳細なモック実装
   - `ClientError` などの例外クラスも適切にモック化

### Firebase認証関連の修正

Firebase認証の初期化問題を解決するために、以下の修正を行いました：

1. `app/core/security.py` の修正：
   - テスト環境で firebase_app にダミー値を設定
   - エラー発生時にもダミー値を設定（例外処理の強化）

2. `test_startup.py` での Firebase モック：
   - Firebase 関連モジュールの詳細なモック実装
   - 認証関連メソッドのモック化

## 4. フロントエンドとの連携

バックエンドサーバーが起動したら、フロントエンドとの連携テストを行います：

### 環境変数の設定

フロントエンドの`.env`ファイルで API 連携設定を調整します：

```
# フロントエンド環境変数
VITE_API_BASE_URL=http://localhost:8000/api
# バックエンドAPIを使用する場合はfalseに設定
VITE_USE_MOCK=false
```

### APIテスト

1. バックエンドサーバーを起動：
   ```bash
   python test_startup.py
   ```

2. フロントエンドサーバーを起動：
   ```bash
   cd ../indie-music-platform-frontend
   npm run dev
   ```

3. ブラウザで`http://localhost:5173`にアクセスし、開発者コンソールでAPIリクエストを確認

## 5. トラブルシューティング

### 問題が再発した場合

1. ログファイル（`test_startup.log`）を確認
2. 環境変数が正しく設定されているか確認
3. `app/utils/storage.py` と `app/core/security.py` が正しく修正されているか確認

### CORSエラーが発生した場合

`app/core/config.py` にフロントエンドの開発サーバーアドレスが追加されているか確認：

```python
CORS_ORIGINS: List[str] = [
    "http://localhost:3000",  # React開発サーバー
    "http://localhost:5173",  # Vite開発サーバー
    # その他必要なオリジン
]
```

## 6. 本番環境への移行

1. `test_startup.py` のようなモック化は開発/テスト環境専用です
2. 本番環境では実際の AWS、Firebase 認証情報を使用してください
3. 本番環境向けの設定は別途用意し、`TESTING=False` に設定してください

## 7. 今後の開発

1. テストカバレッジの向上：モック環境と実環境の両方でテストを実行
2. エラーハンドリングの強化：AWS、Firebase 接続エラーの詳細なロギングと対応
3. 環境別設定の整理：開発、テスト、本番環境の設定を明確に分離

バックエンドサーバーが正常に起動するようになったため、これから実際の API 実装と機能開発に集中できます。

